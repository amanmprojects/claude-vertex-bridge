#!/bin/bash

# modclaude CLI - Run Claude from anywhere with the LiteLLM proxy

# Get the directory where this script is located (resolving symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
MODCLAUDE_HOME="$(cd -P "$(dirname "$SOURCE")" && pwd)"
TARGET_DIR="${1:-.}"
DANGEROUSLY_SKIP_PERMISSIONS=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --dsp)
            DANGEROUSLY_SKIP_PERMISSIONS=true
            shift
            ;;
        *)
            if [[ -d "$1" ]] && [[ $TARGET_DIR == "." ]]; then
                TARGET_DIR="$1"
            fi
            shift
            ;;
    esac
done

# Resolve target directory to absolute path
TARGET_DIR=$(cd "$TARGET_DIR" && pwd)

# Activate the venv from modclaude home
source "$MODCLAUDE_HOME/.venv/bin/activate"

# Change to target directory for Claude
cd "$TARGET_DIR" || exit 1
echo "Running Claude in: $TARGET_DIR"
echo "LiteLLM proxy: http://localhost:8765"
echo ""

# Run Claude (this runs in foreground)
bash "$MODCLAUDE_HOME/start_claude.sh" "$DANGEROUSLY_SKIP_PERMISSIONS"
